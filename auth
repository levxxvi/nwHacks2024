import spotipy
from spotipy.oauth2 import SpotifyClientCredentials
from flask import Flask ,redirect,request, render_template
import os
from datetime import datetime, timedelta, date
import sys
from flask_mysqldb import MySQL
import configparser

app = Flask(__name__)
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = ''
app.config['MYSQL_DB'] = 'nwhacks'
mysql = MySQL(app)

config = configparser.ConfigParser()
config.read('config.ini')

app.secret_key = 'sdaefascsasv'
app.config['CLIENT_ID'] = config['spotify']['CLIENT_ID']
app.config['CLIENT_SECRET'] = config['spotify']['CLIENT_SECRET']
app.config['REDIRECT_URI'] = 'http://localhost:5000/callback'
app.config['AUTH_URL'] = 'https://accounts.spotify.com/authorize'
app.config['TOKEN_URL'] = 'https://accounts.spotify.com/api/token'
app.config['API_BASE_URL'] = 'https://api.spotify.com/v1'

auth_manager = spotipy.oauth2.SpotifyOAuth(app.config['CLIENT_ID'],
                                               app.config['CLIENT_SECRET'],
                                               app.config['REDIRECT_URI'],
                                               scope='user-read-currently-playing playlist-modify-private user-read-recently-played',
                                               show_dialog=True)

@app.route('/')
def index():
    return render_template('home.html')

@app.route('/login')
def login():
    app.config['AUTH_URL'] = auth_manager.get_authorize_url()

    return redirect(app.config['AUTH_URL'])

@app.route('/callback')
def callback():
    global sp
    if request.args.get("code"):
        code = auth_manager.parse_response_code(request.args.get("code"))
        token_info = auth_manager.get_access_token(code)

        token = token_info['access_token']

        sp = spotipy.Spotify(auth=token)

        recently_played = sp.current_user_recently_played(limit=50)
        
        user_info = sp.current_user()
        user_id = user_info['id']

        print(user_id)
        
        if recently_played['items']:
            track_count = {}
            for track in recently_played['items']:
                track_id = track['track']['id']
                track_count[track_id] = track_count.get(track_id, 0) + 1

            most_played_track_id = max(track_count, key=track_count.get)
            
            print(f"Most played track ID in the past day: {most_played_track_id}")

            return redirect('/calendar')
    
    return redirect('/')


@app.route('/calendar', methods = ['POST', 'GET'])
def calendar():
    uid=sp.current_user()['id']
    cursor = mysql.connection.cursor()
    cursor.execute(''' SELECT * FROM moodtracker WHERE User=%s ORDER BY Date DESC LIMIT 1''', (uid,))
    day = cursor.fetchall()[0][1]
    print(day)
    now = date.today()
    if day!=now:
        cursor.execute(''' INSERT INTO moodtracker VALUES(%s,%s,%s,%s)''', (uid,now,"",""))

    
    mysql.connection.commit()
    cursor.close()
    return render_template('calendar.html')

@app.route('/update', methods = ['POST', 'GET'])
def update():
    arr = ["Happy", "Neutral", "Sad", "Angry", "Tired", "Stressed"]
    mood = request.args.get('data')
    uid = sp.current_user()['id']
    while(mood not in arr):
        mood = request.args.get('data')
    now = date.today()
    cursor = mysql.connection.cursor()
    cursor.execute(''' UPDATE moodtracker SET Mood=%s WHERE User=%s AND Date=%s''', (mood,uid,now,))
    mysql.connection.commit()
    cursor.close()
    return render_template('calendar.html')


if __name__ == "__main__":
    app.run()