
# pip3 install spotipy Flask Flask-Session
import spotipy
from spotipy.oauth2 import SpotifyClientCredentials
from flask import Flask ,redirect,request, render_template
import os
from datetime import datetime, timedelta
import sys

app = Flask(__name__)
app.secret_key = 'sdaefascsasv'
app.config['CLIENT_ID'] = '9f8720c821a34ee7b1b881bea3257a50'
app.config['CLIENT_SECRET'] = 'da562de7e4394d559b22fa455bd7e005'
app.config['REDIRECT_URI'] = 'http://localhost:5000/callback'
app.config['AUTH_URL'] = 'https://accounts.spotify.com/authorize'
app.config['TOKEN_URL'] = 'https://accounts.spotify.com/api/token'
app.config['API_BASE_URL'] = 'https://api.spotify.com/v1'

auth_manager = spotipy.oauth2.SpotifyOAuth(app.config['CLIENT_ID'],
                                               app.config['CLIENT_SECRET'],
                                               app.config['REDIRECT_URI'],

                                               scope='user-read-currently-playing playlist-modify-private user-read-recently-played',
                                               show_dialog=True)

@app.route('/')
def index():
    return render_template('home.html')

@app.route('/login')
def login():
    app.config['AUTH_URL'] = auth_manager.get_authorize_url()

    return redirect(app.config['AUTH_URL'])

@app.route('/callback')
def callback():

    if request.args.get("code"):

        token_info = auth_manager.get_access_token(request.args.get("code"),as_dict=False)

        spotify = spotipy.Spotify(auth=token_info,auth_manager=auth_manager)
        


        current_datetime = datetime.now()

        start_of_yesterday = datetime(current_datetime.year, current_datetime.month, current_datetime.day) - timedelta(days=1)

        end_of_yesterday = datetime(current_datetime.year, current_datetime.month, current_datetime.day) - timedelta(seconds=1)

        start_of_yesterday_timestamp = int(start_of_yesterday.timestamp())
        end_of_yesterday_timestamp = int(end_of_yesterday.timestamp())

        app.logger.debug(token_info)
        #app.logger.debug(end_of_yesterday_timestamp)

        recently_played = spotify.current_user_recently_played(before=end_of_yesterday_timestamp, limit=10)
        print("My Array:", recently_played)

        return render_template('calendar.html')
    
    return redirect('/')

@app.route('/recentlyplayed')
def recentlyplayed():

    spotify = spotipy.Spotify(auth_manager=auth_manager)

    app.logger.debug('This is a debug message')
    # Get current date and time

    
    print('This is error output', file=sys.stderr)
    print('This is standard output', file=sys.stdout)

    return

if __name__ == "__main__":
    #app.run()
    app.run(debug=True)
    